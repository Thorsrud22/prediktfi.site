<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrediktFi Verify</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#e9ecff;background:#0a0d1f;overflow-x:hidden}
    .bg{position:fixed;inset:0;pointer-events:none;z-index:0;background:
      radial-gradient(900px 600px at 20% 20%, rgba(88,142,255,.18), transparent 60%),
      radial-gradient(900px 600px at 80% 70%, rgba(0,220,190,.16), transparent 60%),
      radial-gradient(600px 600px at 60% 30%, rgba(150,110,255,.16), transparent 60%),
      linear-gradient(180deg, #0a0d1f 0%, #0c1233 100%);filter:saturate(115%) blur(.2px);animation:drift 22s ease-in-out infinite alternate}
    @keyframes drift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-1%,-1%,0)}}
    .vignette{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 50% 50%, transparent 55%, rgba(0,0,0,.35) 100%)}
    main{position:relative;z-index:2;max-width:900px;margin:0 auto;padding:28px 24px 64px}
    h1{font-size:clamp(28px,5vw,44px);text-align:center;margin:6px 0 18px;
      background:linear-gradient(180deg,#ffffff,#b7c3ff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .panel{margin-top:18px;padding:16px;border-radius:14px;background:rgba(12,18,51,.55);border:1px solid rgba(255,255,255,.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .input{flex:1 1 320px;min-height:44px;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;background:rgba(2,6,20,.35);color:#e9ecff}
    .btn{appearance:none;border:0;border-radius:999px;padding:12px 16px;background:linear-gradient(90deg,#4a8fff,#8a48ff);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(74,143,255,.35)}
    .btn.outline{background:transparent;border:1px solid rgba(255,255,255,.16)}
    .small{font-size:13px;color:#9aa3c6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;word-break:break-all}
    .ok{color:#a6ffb2}
    .fail{color:#ff9aa6}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    a.link{color:#9fb4ff;text-decoration:none}
  </style>
  <!-- Ed25519 verifisering i nettleser -->
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
</head>
<body>
  <div class="bg"></div><div class="vignette"></div>
  <main>
    <div class="top">
      <div class="small">PrediktFi Verify</div>
      <a class="link" href="/alpha.html">Back to Alpha</a>
    </div>
    <h1>Verify signature</h1>

    <div class="panel">
      <div class="row">
        <input id="pubkey" class="input" placeholder="Wallet public key base58" />
      </div>
      <div class="row">
        <textarea id="message" class="input" rows="5" placeholder="Exact message that was signed"></textarea>
      </div>
      <div class="row">
        <input id="signature" class="input" placeholder="Signature base58" />
      </div>
      <div class="row">
        <button id="verifyBtn" class="btn">Verify</button>
        <button id="copyLinkBtn" class="btn outline">Copy share link</button>
      </div>

      <div id="result" class="small mono" style="margin-top:12px"></div>
    </div>
  </main>

  <script>
    // base58 decode
    function base58decode(str){
      const ALPHABET='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      let n=0n; for(const ch of str){ const p=ALPHABET.indexOf(ch); if(p<0) throw new Error('bad base58'); n = n*58n + BigInt(p); }
      let bytes=[]; while(n>0n){ bytes.push(Number(n & 255n)); n >>= 8n; }
      bytes = bytes.reverse();
      let zeros=0; for(const c of str){ if(c==='1') zeros++; else break; }
      return new Uint8Array([...Array(zeros).fill(0), ...bytes]);
    }

    const q = new URLSearchParams(location.search);
    const pubI = document.getElementById('pubkey');
    const msgI = document.getElementById('message');
    const sigI = document.getElementById('signature');
    const res  = document.getElementById('result');

    // Prefyll fra URL
    pubI.value = q.get('pubkey') || q.get('pk') || '';
    msgI.value = q.get('msg') || '';
    sigI.value = q.get('sig') || '';

    async function verify(){
      try{
        const pub = base58decode(pubI.value.trim());
        const sig = base58decode(sigI.value.trim());
        const msg = new TextEncoder().encode(msgI.value);

        const ok = nacl.sign.detached.verify(msg, sig, pub);
        if(ok){
          res.innerHTML = '<span class="ok">Valid signature ✓</span>\n' +
            'pubkey ' + pubI.value + '\n' +
            'signature ' + sigI.value;
        }else{
          res.innerHTML = '<span class="fail">Invalid signature</span>';
        }
      }catch(e){
        res.textContent = 'Verify error: ' + (e?.message || e);
      }
    }

    function copyShareLink(){
      const p = new URLSearchParams({ pubkey: pubI.value.trim(), sig: sigI.value.trim(), msg: msgI.value });
      const url = location.origin + location.pathname + '?' + p.toString();
      navigator.clipboard.writeText(url).then(()=>{
        res.textContent = 'Copied link to clipboard';
      }).catch(()=>{ res.textContent = 'Could not copy link'; });
    }

    document.getElementById('verifyBtn').addEventListener('click', verify);
    document.getElementById('copyLinkBtn').addEventListener('click', copyShareLink);

    // Auto verify når alt er på plass
    if(pubI.value && sigI.value && msgI.value){ verify(); }
  </script>
</body>
</html>
