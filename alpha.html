<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PrediktFi Alpha</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#e9ecff;background:#0a0d1f;overflow-x:hidden}
    .bg{position:fixed;inset:0;pointer-events:none;z-index:0;background:
      radial-gradient(900px 600px at 20% 20%, rgba(88,142,255,.18), transparent 60%),
      radial-gradient(900px 600px at 80% 70%, rgba(0,220,190,.16), transparent 60%),
      radial-gradient(600px 600px at 60% 30%, rgba(150,110,255,.16), transparent 60%),
      linear-gradient(180deg, #0a0d1f 0%, #0c1233 100%);filter:saturate(115%) blur(.2px);animation:drift 22s ease-in-out infinite alternate}
    @keyframes drift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-1%,-1%,0)}}
    .vignette{position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse at 50% 50%, transparent 55%, rgba(0,0,0,.35) 100%)}
    main{position:relative;z-index:2;max-width:1100px;margin:0 auto;padding:28px 24px 64px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{font-weight:800;letter-spacing:.02em;font-size:18px;color:#cfd7ff;opacity:.95}
    .btn{appearance:none;border:0;border-radius:999px;padding:12px 16px;background:linear-gradient(90deg,#4a8fff,#8a48ff);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(74,143,255,.35)}
    .btn.outline{background:transparent;border:1px solid rgba(255,255,255,.16)}
    .linkbtn{display:inline-block;text-decoration:none}
    .wrap{display:grid;gap:22px}
    .hero{text-align:center;margin:10px auto 24px;max-width:780px}
    h1{font-size:clamp(28px,5vw,44px);background:linear-gradient(180deg,#ffffff,#b7c3ff);-webkit-background-clip:text;background-clip:text;color:transparent;margin:6px 0 10px}
    .subtitle{color:#b9c1ec;font-size:clamp(15px,2.2vw,18px)}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(3,minmax(0,1fr));margin-top:14px}
    @media (max-width:950px){.grid{grid-template-columns:1fr}}
    .card{background:rgba(12,18,51,.65);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:18px 18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(6px)}
    .card h3{margin:2px 0 8px;font-size:18px;color:#e7ebff}
    .card p{margin:0;color:#aab3dd;font-size:14px}
    .panel{margin-top:18px;padding:16px;border-radius:14px;background:rgba(12,18,51,.55);border:1px solid rgba(255,255,255,.06)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .input{flex:1 1 320px;min-height:44px;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;background:rgba(2,6,20,.35);color:#e9ecff}
    .small{font-size:13px;color:#9aa3c6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;word-break:break-all}
    footer{text-align:center;color:#8f98c6;padding:28px 0}
  </style>
</head>
<body>
  <div class="bg"></div><div class="vignette"></div>

  <main>
    <div class="top">
      <div class="brand">PrediktFi Alpha</div>
      <button id="connectBtn" class="btn">Connect wallet</button>
    </div>

    <section class="wrap">
      <div class="hero">
        <h1>Preview predictions</h1>
        <p class="subtitle">Connect your Phantom wallet then sign a message to prove authorship and timestamp. This is a simple preview of how on chain predictions can work.</p>
      </div>

      <div class="grid">
        <div class="card"><h3>BTC range this week</h3><p>Sideways chop around key liquidity bands unless macro shock appears.</p></div>
        <div class="card"><h3>SOL gas and fees</h3><p>High throughput with sub second confirms for retail flows.</p></div>
        <div class="card"><h3>Memecoins rotation</h3><p>Rotation back to quality and creator backed tokens as hype fades.</p></div>
      </div>

      <div class="panel">
        <div class="row" style="margin-bottom:10px">
          <input id="predInput" class="input" placeholder="Write a short prediction and include an expiry date" />
          <button id="signBtn" class="btn">Sign message</button>
        </div>
        <div class="small">Your wallet signs the text. No funds moved. You get a verifiable signature you can share.</div>

        <div id="result" class="small mono" style="margin-top:10px"></div>
        <div class="actions" id="actions" style="display:none">
          <button id="copyBtn" class="btn outline" type="button">Copy signature</button>
          <a class="btn linkbtn outline" href="/verify.html">Open verify</a>
          <button id="downloadBtn" class="btn outline" type="button">Download proof.json</button>
        </div>
      </div>

      <!-- History panel -->
      <div class="panel" id="historyPanel">
        <div style="font-weight:700;margin-bottom:8px;">Your signed predictions, local</div>
        <div id="historyList" class="small"></div>
        <div class="actions" style="margin-top:12px;">
          <button id="clearHistoryBtn" class="btn outline" type="button">Clear local history</button>
        </div>
      </div>
    </section>

    <footer>© 2025 PrediktFi</footer>
  </main>

  <script>
    // Base58 encoder uten ekstern lib
    function base58encode(bytes){
      const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      let zeros = 0; for(let i=0;i<bytes.length && bytes[i]===0;i++) zeros++;
      let n = 0n; for(const b of bytes){ n = (n<<8n) + BigInt(b); }
      let s=''; while(n>0n){ const r=Number(n%58n); n/=58n; s=ALPHABET[r]+s; }
      return s || '1'.repeat(zeros);
    }

    const connectBtn = document.getElementById('connectBtn');
    const signBtn = document.getElementById('signBtn');
    const result  = document.getElementById('result');
    const input   = document.getElementById('predInput');
    const actions = document.getElementById('actions');
    const copyBtn = document.getElementById('copyBtn');
    const dlBtn   = document.getElementById('downloadBtn');

    const historyList  = document.getElementById('historyList');
    const clearHistory = document.getElementById('clearHistoryBtn');

    let wallet, lastSig, lastPayload, lastISO;

    // Local storage helpers
    const lsKeyFor = w => `prediktfi.history.${w || 'unknown'}`;
    function loadHistory(w){
      try { return JSON.parse(localStorage.getItem(lsKeyFor(w)) || '[]'); }
      catch { return []; }
    }
    function saveHistoryEntry(w, entry){
      const arr = loadHistory(w);
      arr.unshift(entry);
      localStorage.setItem(lsKeyFor(w), JSON.stringify(arr.slice(0,50)));
      renderHistory(arr);
    }
    function short(s){ return s.length>12 ? s.slice(0,6)+'…'+s.slice(-6) : s; }
    function renderHistory(arr){
      if (!arr || arr.length===0){
        historyList.innerHTML = 'Nothing yet. Sign a prediction to see it here.';
        return;
      }
      historyList.innerHTML = arr.map(e=>{
        const q = new URLSearchParams({ pubkey:e.wallet, sig:e.signature, msg:e.message }).toString();
        const verifyUrl = `/verify.html?${q}`;
        return `
          <div style="padding:10px 12px;border:1px solid rgba(255,255,255,.08);border-radius:10px;margin:8px 0;background:rgba(2,6,20,.35)">
            <div><b>${new Date(e.iso).toLocaleString()}</b></div>
            <div style="margin:4px 0 6px">${e.text}</div>
            <div class="mono">sig ${short(e.signature)} · <a href="${verifyUrl}" style="color:#9fb4ff">Verify</a> · <a href="#" data-copy="${e.signature}" class="copylink" style="color:#9fb4ff">Copy</a></div>
          </div>
        `;
      }).join('');
    }

    // Delegert copy for historikk
    historyList.addEventListener('click', async (ev) => {
      const a = ev.target.closest('a.copylink');
      if (!a) return;
      ev.preventDefault();
      const val = a.getAttribute('data-copy') || '';
      try { await navigator.clipboard.writeText(val); a.textContent='Copied'; setTimeout(()=>a.textContent='Copy', 1000); } catch {}
    });

    clearHistory?.addEventListener('click', () => {
      if (!wallet) return;
      localStorage.removeItem(lsKeyFor(wallet));
      renderHistory([]);
    });

    async function connectWallet(){
      try{
        if (!window.solana || !window.solana.isPhantom){
          window.open('https://phantom.app/', '_blank'); return;
        }
        const resp = await window.solana.connect({ onlyIfTrusted:false });
        wallet = resp.publicKey.toString();
        connectBtn.textContent = wallet.slice(0,4) + '...' + wallet.slice(-4);
        renderHistory(loadHistory(wallet));
      }catch(e){
        result.textContent = 'Could not connect. ' + (e?.message || e);
      }
    }

    async function signMessage(){
      try{
        if (!wallet){ await connectWallet(); if(!wallet) return; }
        const text = input.value?.trim() || 'PrediktFi demo prediction';
        lastISO = new Date().toISOString();
        lastPayload = `PrediktFi signature\nWallet ${wallet}\nISO ${lastISO}\nText ${text}`;
        const encoded = new TextEncoder().encode(lastPayload);

        if (!window.solana.signMessage){
          result.textContent = 'Your wallet does not allow message signing in this context.'; return;
        }
        const signed = await window.solana.signMessage(encoded, 'utf8');
        lastSig = base58encode(signed.signature);

        result.innerHTML =
          'Signed OK\n' +
          'Wallet: ' + wallet + '\n' +
          'ISO: ' + lastISO + '\n' +
          'Signature (base58):\n' + lastSig;

        actions.style.display = 'flex';

        // lagre lokalt
        saveHistoryEntry(wallet, {
          wallet,
          iso: lastISO,
          text,
          message: lastPayload,
          signature: lastSig
        });
      }catch(e){
        result.textContent = 'Signing failed. ' + (e?.message || e);
      }
    }

    copyBtn?.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(lastSig || '');
        copyBtn.textContent = 'Copied ✓';
        setTimeout(()=>copyBtn.textContent='Copy signature', 1200);
      }catch(e){}
    });

    dlBtn?.addEventListener('click', () => {
      if (!lastSig) return;
      const proof = {
        product: 'PrediktFi',
        scheme: 'ed25519',
        encoding: 'base58',
        wallet,
        iso: lastISO,
        message: lastPayload,
        signature: lastSig
      };
      const blob = new Blob([JSON.stringify(proof,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prediktfi-proof-${lastISO.replace(/[:.]/g,'-')}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    });

    connectBtn.addEventListener('click', connectWallet);
    signBtn.addEventListener('click', signMessage);

    // Hvis wallet reconnecter automatisk
    if (window.solana && window.solana.isPhantom){
      window.solana.on?.('connect', () => renderHistory(loadHistory(wallet)));
    }
  </script>
</body>
</html>
